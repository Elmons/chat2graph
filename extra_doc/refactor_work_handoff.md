# 重构协作约定 & 工作交接日志（Codex）

本文件用于记录我（Codex）在本仓库按 `extra_doc/refactor_plan_to_new_arch.md` 推进重构时的**协作约定**与**每次提交的工作日志**，便于你随时接手/回溯。

---

## 1) 变更与提交（Commit）约定

1. **每次修改只聚焦一个部分（一个 Milestone/一个子模块/一个问题）**  
   - 避免“顺手改一下”导致 PR/commit 不可审计、难回滚。
2. **该部分修改完成后必须提交（commit）**，并在 commit message 中写清楚：  
   - 改动范围（哪个模块/哪个 milestone）  
   - 解决了什么问题 / 为什么要改  
   - 是否包含测试与测试范围

> 约定：如果某次改动需要拆成多个 commit（例如“重构 + 迁移测试 + 修复 lint”），也要保证每个 commit 都是可运行/可回滚的最小单元。

---

## 2) 每次更新后的日志要求

每次我提交（commit）后，都要在本文件的 **「4) 工作日志」** 追加一条记录，至少包含：

- 做了什么（What）
- 为什么（Why，可选但推荐）
- 影响范围（Impact）
- 运行了哪些测试（Mock-only）
- 下一步计划（Next）

---

## 3) 测试约定（非常重要）

### 3.1 我实际运行的测试：必须全量 Mock（不真实调用 LLM）

- **我在本地/CI 中实际执行的所有测试，都必须通过 mock 来模拟 LLM 返回**，不得真实请求模型服务。
- 我需要为关键路径构造足够覆盖的用例与 mock（含异常/边界），确保：
  - 测试稳定、可复现、离线可跑
  - 同时保证“真实 LLM 返回”在协议/结构上也能跑通（即 mock 必须贴近真实返回形态）

### 3.2 需要同时提供两类测试：Mock 测试 + Real LLM 测试（实现但不运行）

- **Mock 测试（必须运行）**：默认测试集，保证功能正确性与回归保护。
- **Real LLM 测试（只实现，不需要运行）**：用于验证端到端连通性。约定：
  - 用 pytest marker（例如 `@pytest.mark.real_llm`）隔离
  - 默认不执行（例如需要显式 `-m real_llm` 才会跑）
  - 测试中要清晰声明依赖（环境变量/密钥/网络），并在缺失时自动 skip

### 3.3 测试目录约定

- **所有新增/重构后的测试统一放在 `tests/example/`** 下（不再新增到其他目录）。
- 如果仓库里历史测试目录不一致（例如当前存在 `test/`），会在后续某个独立 commit 中完成迁移/兼容，保证约定落地。

---

## 4) 工作日志（逐次追加）

### 2026-02-12

- What: 初始化本文件（协作约定 & 工作交接日志）。
- Next: 按 `extra_doc/refactor_plan_to_new_arch.md` 从 Milestone A（query-only）开始逐步评估与改造代码，并建立 `tests/example/` 的 mock/real_llm 测试骨架。

